<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ChatBot</title>
    <!-- Make sure this file exists in your static folder -->
    <link rel="stylesheet" href="{{ url_for('static', filename='chatbot.css') }}">
</head>
<body>
<h1>AI Chatbot </h1>

<div id="chatWindow" style="border: 1px solid #000; height: 250px; overflow-y: scroll; padding: 10px;"></div>

<br>

<input id="userInput" type="text" placeholder="Type Your Message..">
<button onclick="sendMessage()">Send</button>
<button onclick="clearHistory()">Clear Conversation</button>

<script>
    let messages = [];
    const inputArea = document.getElementById("userInput");
    const chatWindow = document.getElementById("chatWindow");

    window.onload = function() {
        loadHistory();
    };

    function loadHistory() {
        fetch('/get_history')
            .then(res => res.json())
            .then(data => {
                if(data.history) {
                    data.history.forEach(msg => {
                        // Safety check to ensure text exists
                        if(msg.parts && msg.parts[0]) {
                            let text = msg.parts[0].text;
                            let role = msg.role;
                            if (role == "user") {
                                chatWindow.innerHTML += "<p><b>You:</b> " + text + "</p>";
                            } else {
                                chatWindow.innerHTML += "<p><b>Bot:</b> " + text + "</p>";
                            }
                        }
                    });
                    // FIXED COMMENT: Use // for JavaScript
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }
            })
            // FIXED COMMENT: Use // for JavaScript
            .catch(err => console.error("Error loading history:", err));
    }

    function sendMessage() {
        let text = inputArea.value;
        if (!text) return;

        console.log("Sending: " + text); // Debugging line

        // Add user message to screen immediately
        messages.push({ role: "user", content : text});
        chatWindow.innerHTML += "<p><b>You:</b> " + text + "</p>";
        inputArea.value = "";
        chatWindow.scrollTop = chatWindow.scrollHeight;

        fetch("/ai/chatbot", {
            method: "POST",
            headers: {"Content-Type": "application/json" },
            body: JSON.stringify({prompt: text})
        })
        .then(res => res.json())
        .then(data => {
            console.log("Response received"); // Debugging line
            let reply = data.message;
            messages.push({ role: "model", content: reply });
            chatWindow.innerHTML += "<p><b>Bot:</b> " + reply + "</p>";
            chatWindow.scrollTop = chatWindow.scrollHeight;
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            chatWindow.innerHTML += "<p style='color:red'>Error sending message.</p>";
        });
    }

    function clearHistory() {
        fetch('/clear_history', { method: "POST" })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                console.error("Server failed to clear history");
            }
        })
        .catch(err => console.error("Error:", err));
    }
</script>
</body>
</html>

